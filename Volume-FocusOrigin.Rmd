---
title: "R Notebook"
output: html_document 
---

```{r}
library(dplyr)
library(ggplot2); theme_set(theme_bw())
library(viridis)
library(tidyverse)
library(lubridate)
library("readxl")
library(reshape2)
library(patchwork)  #combine separate ggplots
library(scales)
library(zoo)
library(viridis)
library(RColorBrewer)


## Color palette
cpalete = c( "#999999", "#E69F00", '#336699',"#99FF33", "#CC6699", "#cc0000", "#663399", "#FFFF33")
```
##statcan(Frontier Counts (FC))
```{r}
FC <- read.csv("Data/TraVolData/FC-NL.csv")
colnames(FC)[colnames(FC) == "REF_DATE"] <- "date"
FC$date <- as.Date(as.character(FC$date), format = "%Y-%m-%d")
FC <- FC[FC$date < as.Date("2021-06-01"),] #July 2021

FCEXCrew <- read.csv("Data/TraVolData/FC-NL-nocrews.csv")
colnames(FCEXCrew)[colnames(FCEXCrew) == "REF_DATE"] <- "date"
FCEXCrew$date <- as.Date(as.character(FCEXCrew$date), format = "%Y-%m-%d")
FCEXCrew <- FCEXCrew[FCEXCrew$date < as.Date("2021-06-01"),] #July 2021
```

##IATA
```{r}
IATA <- read.csv("Data/TraVolData/Monthly_travellers_in_NL.csv")
IATA$date <- as.Date(as.character(IATA$date), format = "%Y-%m-%d")


#foriegn
IATA.FR <- IATA
IATA.FR <- select(IATA.FR, -c("Saint.Pierre.and.Miquelon", "NL", "YT","NU","ON","QC",
                      "MB","NB","AB","NS","BC","SK" ,"PE","NT"))
IATA.FR <- dplyr::mutate(IATA.FR, "AllFR" = rowSums((IATA.FR[,2:length(IATA.FR)]), na.rm = TRUE))
IATA.FR <- select(IATA.FR, c("date", "United.States", "AllFR" ))

#canadian all except NL and Saint.Pierre.and.Miquelon
IATA.CA <- IATA
IATA.CA <- select(IATA.CA, c("date", "YT","NU","ON","QC",
                      "MB","NB","AB","NS","BC","SK" ,"PE","NT"))
IATA.CA <- dplyr::mutate(IATA.CA, "ALLCANotNL" = rowSums((IATA.CA[,2:13]), na.rm = TRUE))


#export the interested for the converting to daily later
copy.IATA <- IATA.CA %>% left_join(IATA.FR , by = "date")


IATA <- select(copy.IATA, "date", "AllFR", "ALLCANotNL")
```
## get the percentage of each province in IATA
```{r}
## Add NT, NU,YT together
copy.IATA["TR"] <- rowSums(copy.IATA[, c("NT", "NU", "YT")])
copy.IATA <- select(copy.IATA, -c("NT", "NU", "YT"))
copy.IATA <- copy.IATA  %>% relocate(TR, .before = ALLCANotNL)  #organizing
copy.IATA["nonUS"] <- copy.IATA$AllFR - copy.IATA$United.States
copy.IATA <- copy.IATA %>% rename( PEI = PE, US = United.States)
copy.IATA <- copy.IATA  %>% relocate(nonUS, .before = US)          #organizing
copy.IATA <- copy.IATA  %>% relocate(ALLCANotNL, .before = AllFR)  #organizing


#write.csv(copy.IATA, "Data/TraVolData/cleanIATA.csv", row.names = FALSE)

#make percentage
pcopy.IATA <- copy.IATA
for (i in 1:nrow(pcopy.IATA)){
  for (j in 2:11){
     pcopy.IATA[i,j] <- pcopy.IATA[i,j]*100/pcopy.IATA$ALLCANotNL[i]
  }
  for (j in 12:13){
    pcopy.IATA[i,j] <- pcopy.IATA[i,j]*100/pcopy.IATA$AllFR[i]
  }
}
#test rowSums(pcopy.IATA[,2:13]), rowSums(pcopy.IATA[,14:15])

# remove extra:AlLFR spiltted to US and nonUS (ALLCANotNL, splitted to provinces ex NL) 
pcopy.IATA <- select(pcopy.IATA, -c( "AllFR", "ALLCANotNL" )) 
 
```

##NLCHI
```{r}
NLCHI <- read.csv("Data/TraVolData/TravelVolumeNLCHI.csv")
NLCHI$Date <- as.Date(as.character(NLCHI$Date), format = "%Y-%m-%d") 
NLCHI <- NLCHI %>% rename(date = Date)

#export the interested for the converting to daily later
copy.NLCHI <- select(NLCHI,  c("date", "ON","PEI","QC","SK","YT","AB","BC", "MB","NB", "CA_nop",
                             "NS","NT","NU","USA", "ALLCANotNL", "AllFR" ))


NLCHI <- select(NLCHI, c("date", "AllFR", "ALLCANotNL" ))
```
##get the percentage of each province in NLCHI
```{r}
# add territories (NT, NU,YT) together
# add small amount who does not have province into TR
copy.NLCHI["TR"] <- rowSums(copy.NLCHI[, c("NT", "NU", "YT", "CA_nop")])
copy.NLCHI <- select(copy.NLCHI, -c("NT", "NU", "YT", "CA_nop"))
copy.NLCHI <- copy.NLCHI  %>% relocate(TR, .before = USA)  #organizing
copy.NLCHI["nonUS"] <- copy.NLCHI$AllFR - copy.NLCHI$USA
copy.NLCHI <- copy.NLCHI %>% rename(US = USA)
copy.NLCHI <- copy.NLCHI  %>% relocate(nonUS, .before = ALLCANotNL) # organising


#write.csv(copy.NLCHI, "Data/TraVolData/cleanNLCHI.csv", row.names = FALSE)

# get monthly per province from categorical regression
##add month and year column
copy.NLCHI$year  <- strftime(copy.NLCHI$date, "%Y")   # Create year column
copy.NLCHI$month <- strftime(copy.NLCHI$date, "%m")   # Create month column


#summary(model_Int)
lm.copy.NLCHI <- function(){
  model_ON <- lm(ON ~ month + year , data = copy.NLCHI)      
  model_PEI <- lm(PEI ~ month + year , data = copy.NLCHI)  
  model_QC <- lm(QC ~ month + year , data = copy.NLCHI)      
  model_SK <- lm(SK ~ month + year , data = copy.NLCHI)  
  model_AB <- lm(AB ~ month + year , data = copy.NLCHI)      
  model_BC <- lm(BC ~ month + year , data = copy.NLCHI)  
  model_MB <- lm(MB ~ month + year , data = copy.NLCHI)      
  model_NB <- lm(NB ~ month + year , data = copy.NLCHI)  
  model_NS <- lm(NS ~ month + year , data = copy.NLCHI)      
  model_TR <- lm(TR ~ month + year , data = copy.NLCHI) 
  model_US <- lm(US ~ month + year , data = copy.NLCHI)      
  model_nonUS <- lm(nonUS ~ month + year , data = copy.NLCHI) 
  model_ALLCANotNL <- lm(ALLCANotNL ~ month + year , data = copy.NLCHI)  
  model_AllFR <- lm(AllFR ~ month + year , data = copy.NLCHI)  

  
  copy.NLCHI$ON <- model_ON[["fitted.values"]]
  copy.NLCHI$PEI <- model_PEI[["fitted.values"]]
  copy.NLCHI$QC <- model_QC[["fitted.values"]]
  copy.NLCHI$SK <- model_SK[["fitted.values"]]
  copy.NLCHI$AB <- model_AB[["fitted.values"]]
  copy.NLCHI$BC <- model_BC[["fitted.values"]]
  copy.NLCHI$MB <- model_MB[["fitted.values"]]
  copy.NLCHI$NB <- model_NB[["fitted.values"]]
  copy.NLCHI$NS <- model_NS[["fitted.values"]]
  copy.NLCHI$TR <- model_TR[["fitted.values"]]
  copy.NLCHI$US <- model_US[["fitted.values"]]
  copy.NLCHI$nonUS <- model_nonUS[["fitted.values"]]
  copy.NLCHI$ALLCANotNL  <- model_ALLCANotNL[["fitted.values"]]
  copy.NLCHI$AllFR <- model_AllFR[["fitted.values"]]

  return(copy.NLCHI)
}
#regression and cleanup
lmcopy.NLCHI = lm.copy.NLCHI()
 
# aggregating the daily data
m.copy.NLCHI <- lmcopy.NLCHI %>%                        
  group_by( year, month) %>% 
  dplyr::summarize(ON = sum(ON) , PEI = sum(PEI) , QC = sum(QC),
                   SK = sum(SK), AB = sum(AB), BC = sum(BC),
                   MB = sum(MB), NB = sum(NB), NS = sum(NS),
                   TR= sum(TR) ,
                   US = sum(US), nonUS = sum(nonUS),
                   ALLCANotNL = sum(ALLCANotNL), AllFR=sum(AllFR)) %>%
  as.data.frame()

# to check the result some equal aggregate
#AA <- aggregate(nonUS ~ month + year, copy.NLCHI, FUN = sum)
#test sum(copy.NLCHI$ON[243:273]) or sum(copy.NLCHI$BC[1:30])

#make one column for date
m.copy.NLCHI <- m.copy.NLCHI %>%
  mutate(date = with(., sprintf("%s-%02s", year, month)))
m.copy.NLCHI$date <- as.Date(paste(m.copy.NLCHI$date,"-01",sep=""))  # convert to date
m.copy.NLCHI <- m.copy.NLCHI  %>% relocate(date, .before = year) # organising
m.copy.NLCHI <- select(m.copy.NLCHI , -c(year, month))

#write.csv(m.copy.NLCHI,  "Data/TraVolData/month_cleanNLCHI.csv", row.names = FALSE)


#make percentage
pcopy.NLCHI <- m.copy.NLCHI
for (i in 1:nrow(pcopy.NLCHI)){
  for (j in 2:11){
     pcopy.NLCHI[i,j] <- pcopy.NLCHI[i,j]*100/pcopy.NLCHI$ALLCANotNL[i]
  }
  for (j in 12:13){
     pcopy.NLCHI[i,j] <- pcopy.NLCHI[i,j]*100/pcopy.NLCHI$AllFR[i]
  }
}

# remove extra:AlLFR spiltted to US and nonUS (ALLCANotNL, splitted to provinces ex NL) 
pcopy.NLCHI <- select(pcopy.NLCHI, -c( "AllFR", "ALLCANotNL" ))
```
##plot regression NLCHI
```{r}
BB <- NLCHI %>% left_join(lmcopy.NLCHI, by= "date")
colLeg <- c("INT" = cpalete[1], "CA" = cpalete[2])

p1 <- ggplot() + 
  geom_point(data=BB, aes(x=date, y= ALLCANotNL.x, color='CA')) +
  geom_line( data=BB, aes(x=date, y= ALLCANotNL.y, col='CA'), size=1) +
  geom_point(data=BB, aes(x=date, y= AllFR.x, color= 'INT')) +
  geom_line( data=BB, aes(x=date, y=AllFR.y, col='INT'), size=1) +
  
  labs(x="", y="\n Arriving travellers (daily)", title="Travel volume (TDF)") +
  scale_x_date(date_breaks = "1 month", date_labels = "%b %y") +
  scale_color_manual(values = colLeg) +
  guides(color = guide_legend(title = "Departure Origin"), size= rel(1.4))+
  theme_classic() + theme(axis.text.x = element_text(angle = 90, size=rel(1.2)), 
                          #legend.title = title('Departure Origin'),
                          legend.position="bottom",
                          legend.text=element_text(size=rel(1.2)),
                          plot.title=element_text(size=rel(1.3), face="bold"),
                          axis.title = element_text(size=rel(1.1)),
                          axis.text.y = element_text(size=rel(1.2)))


p1
```

# Pre-pandemic
##visualize Air from international (IATA) and all from Intenational(FC) - pre pandemic 
```{r}
Vis <- IATA
Vis <- Vis %>% left_join(FC, by='date') 

colLeg <- c("IATA" = cpalete[6], "FC" = cpalete[7])
p2 <- ggplot() + 
  geom_point( data= Vis, aes(x=date, y=AllFR ,  color='IATA')) +
  geom_point( data= Vis, aes(x=date, y=total , color='FC')) +
  scale_x_date(date_breaks = "1 month", date_labels = "%b %y") +
  labs(x="", y="\n Arrival travellers", title="Pre-pandemic, International origin") +
  scale_color_manual(values = colLeg) +
  guides(color = guide_legend(title = "Data Source"), size=rel(1.4)) +
  theme_classic() + theme(axis.text.x = element_text(angle = 90, size=rel(1.3)), 
                          legend.position="bottom",
                          legend.text=element_text(size=rel(1.2)),
                          plot.title=element_text(size=rel(1.4), face="bold"),
                          axis.title = element_text(size=rel(1.3)),
                          axis.text.y = element_text(size=rel(1.3)))



p2
```
# Pre-pandemic
## 1.1 Pre pandemic CA Origins - 2016 report (3.3) regardless of origin
```{r}
## Find Pre pandemic from CA origins by Auto from Air(IATA-CA)
## Spring/Summer 73 air, 27 other Fall/Winter 81 air, 19 other, 88 air and 12 other 
## April-August 73/27 air/other, Sep-Oct-Nov-March 81/19 , Dec-Jan-Feb 88/12 
# Make a dataframe 
date <- seq(as.Date("2019-01-01"),as.Date("2020-03-01"),by = "month")  # Remove/Add March
PrePandemic <- as.data.frame(date)
PrePandemic["Air_CA"] <- IATA$ALLCANotNL[1:15] #15
PrePandemic["CA1"] <- NA

#April-August 
for (i in 4:8){
  PrePandemic$CA1[i] <- (PrePandemic$Air_CA[i])*(1/0.73)  
}
 
# Jan, Feb 2019/2020, Dec
for (i in 1:2){
  PrePandemic$CA1[i] <- (PrePandemic$Air_CA[i])*(1/0.88)
}
for (i in 12:14){
PrePandemic$CA1[i] <- (PrePandemic$Air_CA[i])*(1/0.88)
}

# sep- Nov, March2019/2020
for (i in 9:11){
  PrePandemic$CA1[i] <- (PrePandemic$Air_CA[i])*(1/0.81)
}
PrePandemic$CA1[3] <- (PrePandemic$Air_CA[3])*(1/0.81)
PrePandemic$CA1[15] <- (PrePandemic$Air_CA[15])*(1/0.81)

#crews members from Int
PrePandemic["crew_Int"] <- FC$total[1:15] - FCEXCrew$total[1:15]

# Assume twice crew_int for crew_Int per month
#portion of travelers as crew members and private planes/ships from Canadian origins
PrePandemic["CA"] <- PrePandemic$CA1 + 2.5*PrePandemic$crew_Int
PrePandemic["CA"] <- round(PrePandemic["CA"]) 

PrePandemic["Int"] <- FC$total[1:15]

PrePandemic["total"] <- rowSums(PrePandemic[,c("CA", "Int")])
```

## (Pre pandemic) bar-plot fraction of CA/Int arrival in NL 
```{r}
## add Int-Air/auto/total and CA-Air/auto/total to the prepandemic dataframe
plotpre <- select(PrePandemic, c("date", "Int", "CA"))
plotpre <- plotpre[1:15,] ##3:14
plotpre <- melt(plotpre, id=c("date"))

ggplot(data=plotpre , aes(x=date, y=value, fill=variable)) +
  geom_bar(stat="identity") +
  scale_x_date(date_breaks = "1 month", date_labels = "%b %y") +
  #scale_y_continuous(breaks = c(100000, 200000, 300000, 400000,500000))+
  labs(color=" ", 
       title="Pre-pandemic",
       y="\n Arrival travellers",
       x="") +
  theme(axis.title = element_text(size = 12)) +
  #theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 13))+
  guides(fill = guide_legend(title = "Departure Origin"), size=rel(1.4))+
  theme(legend.position="right") +
  scale_fill_manual(values=c(cpalete[1], cpalete[2])) +
  theme_classic() + theme(axis.text.x = element_text(angle = 90, size=rel(1.3)), 
                          legend.title = element_blank(),
                          legend.text=element_text(size=rel(1.2)),
                          plot.title=element_text(size=rel(1.4), face="bold"),
                          axis.title = element_text(size=rel(1.3)),
                          axis.text.y = element_text(size=rel(1.3)))



```



# During pandemic
## Report 2020-2021
```{r}
GV <- read.csv("Data/TraVolData/GVReport21.csv")
GV$date <- as.Date(as.character(GV$date), format = "%Y-%m-%d")
GV <- GV %>% filter(GV$date >= as.Date("2020-03-01") & GV$date <= as.Date("2021-05-01"))

GV["GV_nonres"] <- GV$auto + GV$air
```
## make a dataframe for pandemic
```{r}
Pandemic <- select(GV, c("date",  "GV_nonres"))

Pandemic <- Pandemic %>% left_join( FC, by='date')
colnames(Pandemic)[colnames(Pandemic) == "total"] <- "FC"

##add FCEXCrew
Pandemic <- Pandemic %>% left_join( FCEXCrew, by='date')
colnames(Pandemic)[colnames(Pandemic) == "total"] <- "FC_Excrew"

Pandemic["crew_Int"] <- Pandemic$FC - Pandemic$FC_Excrew

```

## NLCHI month from previous chuncks
```{r}
NLCHI_month <- select(m.copy.NLCHI, c("date" , "ALLCANotNL", "AllFR" ))
NLCHI_month <- NLCHI_month %>% rename( NLCHI_CA = ALLCANotNL , NLCHI_Int = AllFR)
```

## Make a monhly dataframe during the pandemic to compare with FC data and GV report
```{r}
##add other info e.g. FC , GV data from Pandemic dataframe 

Pandemic_month <- NLCHI_month %>% left_join( Pandemic, by='date')

```
##visualize all from International(FC) vs NLCHI - During-pandemic
```{r}
Vis2 <- Pandemic_month

colLeg <- c("TDF-INT" = cpalete[6], "FC" =cpalete[7]) 
p3 <- ggplot() + 
  geom_point( data= Vis2, aes(x=date, y=NLCHI_Int ,  color='TDF-INT')) +
  geom_point( data= Vis2, aes(x=date, y=FC , color='FC')) +
  scale_x_date(date_breaks = "1 month", date_labels = "%b %y") +
  labs(x="", y="\n Arrival travellers", title="During pandemic, International origin") +
  scale_color_manual(values = colLeg) +
  guides(color = guide_legend(title = "Data Source"), size= rel(1.4))+
  theme_classic() + theme(axis.text.x = element_text(angle = 90, size=rel(1.3)), 
                          legend.position="bottom",
                          legend.text=element_text(size=rel(1.2)),
                          plot.title=element_text(size=rel(1.4), face="bold"),
                          axis.title = element_text(size=rel(1.3)),
                          axis.text.y = element_text(size=rel(1.3)))


p3
```
##visualize all (government vs NLCHI) - During-pandemic
```{r}
Vis2 <- Pandemic_month
Vis2["NLCHI"] <- Vis2$NLCHI_Int+ Vis2$NLCHI_CA

colLeg <- c("TDF" = cpalete[6], "GV" = cpalete[7]) 
p4 <- ggplot() + 
  geom_point( data= Vis2, aes(x=date, y=NLCHI ,  color='TDF')) +
  geom_point( data= Vis2, aes(x=date, y=GV_nonres , color='GV')) +
  scale_x_date(date_breaks = "1 month", date_labels = "%b %y") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 11))+
  labs(x="", y="\n Arrival travellers", title="During pandemic-Nonresident tavelers") +
  scale_color_manual(values = colLeg) +
  guides(color = guide_legend(title = "Data Source"), size=rel(1.4)) +
  theme_classic() + theme(axis.text.x = element_text(angle = 90, size=rel(1.3)), 
                          legend.position="bottom",
                          legend.text=element_text(size=rel(1.2)),
                          plot.title=element_text(size=rel(1.4), face="bold"),
                          axis.title = element_text(size=rel(1.3)),
                          axis.text.y = element_text(size=rel(1.3)))

p4

```

##Equation 5  (use NLCHI data, so it is from Sep 20 to May 21)
```{r}
#Exempt from International,  compare (FCInt) vs NLCHI_Int (should include FCNonRes!)
Pandemic_month["Exp_Int"] <-  Pandemic_month$FC_Excrew -  Pandemic_month$NLCHI_Int 

#Exempt from CA
Pandemic_month["crew_CA"] <- 2.5*Pandemic_month$crew_Int  #crew from CA
Pandemic_month["Exp_CA"] <- 2.4*Pandemic_month$Exp_Int    #excluded crew


# update CA 
Pandemic_month["CA"] <- Pandemic_month$NLCHI_CA + Pandemic_month$Exp_CA + 
                            Pandemic_month$crew_CA
Pandemic_month["Int"] <- Pandemic_month$FC
Pandemic_month["Eq5"] <- round(Pandemic_month$CA)

DailyNewPan <- Pandemic_month

Pandemic_month <- select(Pandemic_month, c("date", "Int", "Eq5"))
```
# All time - merging
## make One data frame(pre-duing pandemic with Eq5 or Eq6)
```{r}
PrePandemic <- select(PrePandemic, c('date', 'Int', 'CA'))

#merge with pandemic (Eq5)
colnames(Pandemic_month)[colnames(Pandemic_month) == "Eq5"] <- "CA"
Final_data <- rbind(PrePandemic, Pandemic_month)

Final_data["estimated"] <- rowSums(Final_data[,2:3], na.rm=TRUE)

```
##plot all time
```{r}
##plot all time 
Vis3 <- select(Final_data,  c("date","Int" ,"CA" ))
Vis3 <- Vis3 %>% rename( INT = Int )
Vis3 <- subset(Vis3, !date %in% c(as.Date("2019-01-01"), as.Date("2019-02-01")) ) #dont plot Jan&Feb20119

#Final[is.na(Final)] <- 0
plot <- melt(Vis3, id=c("date"))

cut1 <- data.frame(Ref = c("Public Health Emergency in NL"),
                   vals = c(as.Date("2020-03-20")),
                   stringsAsFactors = FALSE)

cut2 <- data.frame(Ref = c( "Travel declaration data begins"),
                   vals = c(as.Date("2020-08-15")),
                   stringsAsFactors = FALSE)


p5 <- ggplot() +
  geom_bar(data=plot , aes(x=date, y=value, fill=variable), stat="identity") +
  geom_vline(mapping = aes(xintercept = vals), linetype="dashed", data = cut1, show.legend = FALSE, size=0.3) +
  geom_vline(mapping = aes(xintercept = vals), linetype="dashed", data = cut2, show.legend = FALSE, size=0.3) +
  scale_x_date(date_breaks = "1 month", date_labels = "%b %y") +
  labs(color=" ", 
       title="Total travel volume",
       y="\n Arriving travellers (monthly)",
       x="") +
  guides(fill = guide_legend(title = "Departure Origin"))+
  theme(legend.position="right") +
  scale_fill_manual(values=c(cpalete[1], cpalete[2])) + 
  geom_text(mapping = aes(x = vals, y = 210000, label = Ref, hjust = 1.2, vjust =  1.5, angle = 90),
           data = cut1, size=rel(3.1))  +
  geom_text(mapping = aes(x = vals, y = 220000, label = Ref, hjust = 1.2, vjust = - 0.5, angle = 90),
           data = cut2, size=rel(3.1))  +
  theme_classic() + theme(axis.text.x = element_text(angle = 90, size=rel(1.2)), 
                          legend.position="bottom" ,
                          legend.text=element_text(size=rel(1.2)),
                          plot.title=element_text(size=rel(1.3), face="bold"),
                          axis.title = element_text(size=rel(1.1)),
                          axis.text.y = element_text(size=rel(1.2)))

p5

```

##plot reduction based Eq5 for origin CA
```{r}
plot1.df <- FC
plot1.df <- plot1.df %>% rename(FC = total)
plot1.df <- plot1.df %>% left_join( NLCHI_month, by='date') #raw NLCHI
plot1.df["NLCHI"] <- plot1.df$NLCHI_CA + plot1.df$NLCHI_Int
plot1.df <- plot1.df  %>% left_join(IATA, by='date')  #raw IATA
plot1.df["IATA"] <- plot1.df$AllFR + plot1.df$ALLCANotNL
plot1.df <- plot1.df %>% left_join(Final_data, by= 'date') 

write.csv(plot1.df , "Data/ref_mFinal.csv", row.names = FALSE)

# remove Jan and Feb 2019
plot1.df <- subset(plot1.df, !date %in% c(as.Date("2019-01-01"), as.Date("2019-02-01")) )

#as.Date("2021-01-21"),
cuts <- data.frame(Ref = c("1", "2", "3", "4", "5", "6","7","8","9"),
                   vals = c(as.Date("2020-03-13"), as.Date("2020-05-04"),as.Date("2020-06-09"),
                            as.Date("2020-07-03"), as.Date("2020-08-31"), as.Date("2020-10-20"), 
                            as.Date("2020-11-25"),as.Date("2021-02-01"),
                            as.Date("2021-03-27")), stringsAsFactors = FALSE)

cut3 <- data.frame(Ref = c("81.6% decrease"),
                   vals = c(as.Date("2021-01-28")),
                   stringsAsFactors = FALSE)


colLeg <- c("IATA" = cpalete[4], "TDF" = cpalete[5],
            "FC" = cpalete[3], "Estimated"= cpalete[6])

p10 <- ggplot() +
  geom_line(data=plot1.df, aes(x=date, y= estimated, col="Estimated"), lty=1, size=1)+
  geom_line(data=plot1.df, aes(x=date, y= IATA, col="IATA"), lty=1, size=0.7)+
  geom_line(data=plot1.df, aes(x=date, y= NLCHI, col="TDF"), lty=1, size=0.7)+
  geom_line(data=plot1.df, aes(x=date, y= FC, col="FC"), linetype="dashed", lty=2, size=0.7)+
  
  annotate("rect", xmin = as.Date("2020-03-01"), xmax =as.Date("2020-09-01"), ymin = 0,
           ymax = 210000, alpha = .1)+
  geom_vline(mapping = aes(xintercept = vals), linetype="dashed", data = cuts, show.legend = FALSE, size=0.3) +
  geom_text(mapping = aes(x = vals, y = 200000, label = Ref, hjust = 1.2, vjust = -.5), data = cuts,
            size=3, fontface="bold") +
  geom_text(mapping = aes(x = vals, y = 30000, label = Ref, hjust = .13, vjust =  0.1, angle = 0),
           data = cut3, size=rel(3.2), color= cpalete[6], fontface="bold")  +
  scale_x_date(date_breaks = "1 month", date_labels = "%b %y") +
  theme_light() + labs(color=" ", title="Travel volume", y="\n Arriving travellers (monthly)", x="") +
  scale_color_manual(values = colLeg) +
  theme_classic() + theme(axis.text.x = element_text(angle = 90, size=rel(1.2)), 
                          legend.title = element_blank(),
                          legend.position="bottom",
                          legend.text=element_text(size=rel(1.2)),
                          plot.title=element_text(size=rel(1.3), face="bold"),
                          axis.title = element_text(size=rel(1.1)),
                          axis.text.y = element_text(size=rel(1.2)))

p10
#ggsave("Figure/fig1.png", width = 10, , height = 7)

```

## reduction (based eq5)
```{r}
## March2019-Feb2020 (not June-july-August since during pandemic we dont have thoes)
xx <- Final_data
xx <- subset(xx, !date %in% c(as.Date("2019-01-01"), as.Date("2019-02-01"), as.Date("2020-03-01"),
                              as.Date("2019-06-01"), as.Date("2019-07-01"), as.Date("2019-08-01")) )
rownames(xx) <- NULL  # Reset row names
#9 months
#2019-2020 (before pan)
tot20 <- sum(xx[1:9, 'estimated'], na.rm = TRUE)  #Int, CA, or estimated
#2020-2021 (pan)
tot21 <- sum(xx[10:18, 'estimated'], na.rm = TRUE)  #Int, CA, or estimated
##percentage decrease
decrease <- tot20 - tot21
(decrease/tot20)*100
##81.5865

##sep to Feb (5 month)
mean20 <- mean(Final_data$estimated[9:14])
mean21 <- mean(Final_data$estimated[16:21])
##percentage decrease mean
decmean <- mean20 - mean21
(decmean/mean20)*100
## 81.67392
```


## merging Final volume with percentage (NLCHI -IATA)- correct 
```{r}
# make one dataframe for percentage IATA and NLCHI
per12 <- rbind(pcopy.IATA, pcopy.NLCHI)
write.csv(per12, "Data/per12.csv", row.names = FALSE)

CRFinal <- per12 %>% left_join(Final_data, by= 'date')

#make volume for origin/month
for (i in 1:nrow(CRFinal)){
  for (j in 2:11){
     CRFinal[i,j] <- (CRFinal[i,j]*CRFinal$CA[i])/100
  }
  for (j in 12:13){
     CRFinal[i,j] <- (CRFinal[i,j]*CRFinal$Int[i])/100
  }
}

#test rowSums(CRFinal[,2:11]) , rowSums(CRFinal[,2:13])
write.csv(CRFinal, "Data/CRfinal.csv", row.names = FALSE)

#percentage Int and CA close to estimated
CRPer <- CRFinal
for (i in 1:nrow(CRPer)){
  for (j in 2:length(CRPer)){
     CRPer[i,j] <- (CRPer[i,j]*100)/(CRPer$estimated[i])
  }
}
CRPer <- select(CRPer, -c("Int", "CA", "estimated"))

#write.csv(CRPer, "Data/CRPer.csv", row.names = FALSE)

```

# plot percent after correction (plot stack percentage IATA and NLCHI )
```{r}
#delete Jan and Feb 2019 from IATA 
ff <- CRPer
ff <- subset(ff, !date %in% c(as.Date("2019-01-01"), as.Date("2019-02-01")) )

ff1 <- melt(ff, id=c("date"))

#mycolors = brewer.pal(n = 12, name = 'Paired')
mycolors = viridis(12) #turbo magma 14 Spectral
colormap <- c("US" = mycolors[12], "nonUS" = mycolors[11], "ON" = mycolors[10],
              "NS" = mycolors[9], "AB" = mycolors[8], "BC" = mycolors[7], 
              "QC" = mycolors[6], "NB" = mycolors[5], "MB" = mycolors[4], 
              "SK" = mycolors[3], "PEI"= mycolors[2], "TR" = mycolors[1]
             )

cut1 <- data.frame(Ref = c("Public Health Emergency in NL"),
                   vals = c(as.Date("2020-03-20")),
                   stringsAsFactors = FALSE)

cut2 <- data.frame(Ref = c( "Travel declaration data begins"),
                   vals = c(as.Date("2020-08-15")),
                   stringsAsFactors = FALSE)


 p6 <- ggplot() +
  geom_bar(data=ff1 , aes(x=date, y=value, fill=variable),stat="identity") +
  scale_x_date(date_breaks = "1 month", date_labels = "%b %y") +
  geom_vline(mapping = aes(xintercept = vals), linetype="dashed", data = cut1, show.legend = FALSE, size=0.3) +
   geom_vline(mapping = aes(xintercept = vals), linetype="dashed", data = cut2, show.legend = FALSE, size=0.3) +
  labs(color=" ", 
       title="Percentage of travellers arriving from different origins",
       y="\n ",
       x="") +
  scale_fill_manual(values = colormap) +
  guides(fill = guide_legend(title = "Departure Origin"), size= rel(1.4))+
  geom_text(mapping = aes(x = vals, y = 100, label = Ref, hjust = 1.2, vjust =  1.5, angle = 90),
           data = cut1, size=rel(3.1))  +
  geom_text(mapping = aes(x = vals, y = 100, label = Ref, hjust = 1.2, vjust = - 0.5, angle = 90),
           data = cut2, size=rel(3.1))  +
  theme_classic() + theme(axis.text.x = element_text(angle = 90, size=rel(1.2)), 
                          legend.position="bottom" ,
                          legend.text=element_text(size=rel(1.2)),
                          plot.title=element_text(size=rel(1.3), face="bold"),
                          axis.title = element_text(size=rel(1.1)),
                          axis.text.y = element_text(size=rel(1.2))) + 
  scale_y_continuous(labels = function(x) paste0(x*1, "%"))

p6

```
# for regresion (glm) supporting stack plotting
```{r}
ff <- CRPer
ff <- subset(ff, !date %in% c(as.Date("2019-01-01"), as.Date("2019-02-01"), as.Date("2020-03-01")) )
# we do not have June, July and August for NLCHI, so remove from IATA
ff <- subset(ff, !date %in% c(as.Date("2019-06-01"), as.Date("2019-07-01"), as.Date("2019-08-01")))


meltper <- melt(ff, id=c("date"))
meltper <- meltper %>% rename( origin=variable, proport=value)
#add month-date
meltper$year  <- strftime(meltper$date, "%Y")   
meltper$month <- strftime(meltper$date, "%m") 

meltper["beforeafter"] <- NA
for (i in 1:nrow(meltper)){
  if (meltper$date[i] < as.Date("2020-03-01") ) {meltper$beforeafter[i] <- "before"} 
  else {meltper$beforeafter[i] <- "after"}
}

## make column as factor
meltper <- meltper %>% mutate(month = as.factor(month), beforeafter = as.factor(beforeafter),
                     year = as.factor(year), origin= as.factor(origin))

meltper$proport <- (meltper$proport)/100 # respond variable should be between 0, 1 for bionomial

model <- glm( proport ~ month + beforeafter + origin , family = binomial , data=meltper)  #year
summary(model)

#Is an interaction term significant?
lm.interact <- glm(proport ~ beforeafter*origin, family = binomial, data = meltper)
summary(lm.interact)

anova(model, lm.interact)

anova(model, lm.interact, test = "Chisq")

# not ON anova less with "Chisq" test
```
## Daily tra- during the pandemic
```{r}
##DailyNewPan
Daily1 <- select(DailyNewPan, c("date", "NLCHI_CA", "NLCHI_Int", "FC", "crew_CA", "Exp_CA" ))
#excluded of NLCHI for INT and CA
Daily1["exclINT"] <- Daily1$FC - Daily1$NLCHI_Int
Daily1["exclCA"] <- Daily1$crew_CA + Daily1$Exp_CA

perCAPan <- per12 %>% filter(per12$date >= as.Date("2020-09-01"))
perCAPan <- select(perCAPan, -c(nonUS, US))

## devided excluded CA based perCAPan between provinces per month
Dailypro <- perCAPan
for (i in 1:nrow(Dailypro)){
  for (j in 2:length(Dailypro)){
    Dailypro[i,j] <- (Daily1$exclCA[i])*(perCAPan[i,j]/100)
  }
}
## check rowSums(Dailypro[,2:11])= excluded CA in Daily1

## make a dataframe of exculded NLCHI for province and INT
Dailypro <- Dailypro %>% left_join(select(Daily1, c(date, exclINT)), by ="date")

# make data excluded daily 273
Dailypro["Ym"] <- format(as.Date(Dailypro$date), "%Y-%m")

Daily2 <- Dailypro %>% select(date) %>% 
   complete(date=  seq.Date(min(date), max(date)+30, by="day"),) %>% 
   mutate(Ym=paste(year(date),str_pad(month(date), 2, pad = "0"),sep = "-"))

Daily2 <- Daily2 %>% left_join(Dailypro, by="Ym")
# divide number for days in a month
v_daily <- function(yr_month, v_monthly) {
   # Convert current month to current date
   curr_date <- ymd(paste0(yr_month, "-1"))
   # Calculate number of days in the month
   n_days <- days_in_month(curr_date)
  # Calculate daily rate
   (v_monthly) / (n_days)
}

Daily2 <- Daily2 %>%
   mutate(ON = map2_dbl(Ym, ON, v_daily), QC = map2_dbl(Ym, QC, v_daily), 
          MB = map2_dbl(Ym, MB, v_daily), NB = map2_dbl(Ym, NB, v_daily),
          AB = map2_dbl(Ym, AB, v_daily), NS = map2_dbl(Ym, NS, v_daily), 
          BC = map2_dbl(Ym, BC, v_daily), SK = map2_dbl(Ym, SK, v_daily), 
          PEI = map2_dbl(Ym, PEI, v_daily), TR = map2_dbl(Ym, TR, v_daily),
          exclINT = map2_dbl(Ym, exclINT, v_daily)
          )
 
#keep the interested columns
Daily2 <- select(Daily2, -c("date.y", "Ym")) %>% rename(date = date.x)
Daily2 <- Daily2 %>% rename(INT= exclINT)
# check rowSums(Daily2[1,2:11])*30 = 15048
# round data
#Daily2 <- data.frame(lapply(Daily2, function(x) if(is.numeric(x)) floor(x, 0) else x))
                           
# Daily2 is Daily excluded, now it is time to add it to NLCHI (TDF)

NLCHI <- read.csv("Data/TraVolData/TravelVolumeNLCHI.csv")
NLCHI$Date <- as.Date(as.character(NLCHI$Date), format = "%Y-%m-%d") 
NLCHI <- NLCHI %>% rename(date = Date)

TDF <- select(NLCHI,  c("date", "ON","PEI","QC","SK","YT","AB","BC", "MB","NB", "CA_nop",
                             "NS","NT","NU", "AllFR" ))

TDF["TR"] <- rowSums(TDF[, c("NT", "NU", "YT", "CA_nop")])
TDF <- select(TDF, -c("NT", "NU", "YT", "CA_nop"))
TDF <- TDF  %>% relocate(TR, .before = AllFR)  #organizing
TDF <- TDF %>% rename(INT = AllFR )

# add exluded daily to TDF daily
Tra_daily2 <- TDF 
origin <- c("ON","QC","MB", "NB", "AB", "NS", "BC", "SK", "PEI", "TR","INT")
for (i in 1:length(origin)){
  pr <- origin[i]
  for (j in 1:nrow(Tra_daily2)){
    Tra_daily2[j, pr] <- TDF[j, pr] + Daily2[j,pr]
  }
}
#write.csv(Tra_daily2, "Data/CRdaily2.csv", row.names = FALSE)
```


## canada Map (NLCHI and IATA) - It is possible for one date (consider average 9-month September to May)
```{r}
AA <- CRPer
# get the average months March 2019 to Feb 2020 (except June July August 2019) IATA (before Pandemic)
AA <- subset(AA, !date %in% c(as.Date("2019-01-01"), as.Date("2019-02-01"), as.Date("2020-03-01"), as.Date("2019-06-01"), as.Date("2019-07-01"), as.Date("2019-07-01"), as.Date("2019-08-01")) )
# Reset row names
rownames(AA) <- NULL                

#prepan
AA1 <- AA[1:9,]
#pan
AA2 <- AA[10:18,]

# get the mean for both dataframe
A1 <- colMeans(AA1[2:13])
A2 <- colMeans(AA2[2:13])

A1 <- data.frame(A1)
A1 <- cbind(province = rownames(A1), A1)
rownames(A1) <- 1:nrow(A1)
#test sum(A1$A1)=100
#repeat TR for three tritories
A1[nrow(A1) + 1,] <- c( "YT",  0.338555269656022)
A1[nrow(A1) + 1,] <- c( "NT", 0.338555269656022)
A1[nrow(A1) + 1,] <- c( "NU",0.338555269656022)
A1$A1 <- as.numeric(A1$A1)
A1 <- A1 %>% rename(Percentage = A1)
A1$province[A1$province == 'PEI'] <- 'PE'


A2 <- data.frame(A2)
A2 <- cbind(province = rownames(A2), A2)
rownames(A2) <- 1:nrow(A2)
#repeat TR for three tritories
A2[nrow(A2) + 1,] <- c( "YT", 3.62752706114931)
A2[nrow(A2) + 1,] <- c( "NT", 3.62752706114931)
A2[nrow(A2) + 1,] <- c( "NU", 3.62752706114931)
A2$A2 <- as.numeric(A2$A2)
A2 <- A2 %>% rename(Percentage = A2)
A2$province[A2$province == 'PEI'] <- 'PE'


## canada map
library(mapcan)
#ColourPalette <- RColorBrewer::brewer.pal(11, 'Spectral') 

pr_geographic <- mapcan(boundaries = province, type = standard)
pr_geographic <- inner_join(pr_geographic, A1, by = c("pr_alpha" = "province")) 

m1 <- pr_geographic %>%
  ggplot(aes(x = long, y = lat, group = group, fill = Percentage)) +
  geom_polygon(alpha= 1, show.legend = NA) +
  annotate(geom = "text", x = 642412.6, y = 201110.2, label = "27%", color = "white", size = 3)+
  annotate(geom = "text", x = 1349519.2, y = 782762.2,label = "14%", color = "white", size = 3)+
  annotate(geom = "text", x = -115306.8, y = 644233.4,label = "0.7%",color = "white", size = 3)+
  annotate(geom = "text", x = 2163606.1, y = 237946.6, label = "3%", color = "white", size = 3)+
  annotate(geom = "text", x = -1092152.6,y = 809288.2, label = "7%", color = "white", size = 3)+
  annotate(geom = "text", x = -1867594.7,y =912726.5, label = "2.5%",color = "white", size = 3)+
  annotate(geom = "text", x = -675361.6, y = 487741.4,label = "0.5%",color = "white", size = 3)+
  annotate(geom = "text", x = -888417.3, y = 1651194.8,label = "0.3%",color ="white", size = 3)+
  annotate(geom = "text", x = 2413606.1, y = 421394.6,label = "0.6%",color ="black", size = 3)+
  annotate(geom = "text", x = 2695757.5, y = 232727.5,label = "22%", color = "black", size = 3)+
  annotate(geom = "text", x = 1565757, y = -750409 , label = "US 14% & Others 8%", 
           fontface = "italic", color = "black", size = 3) +
  coord_fixed() +
  theme_mapcan() +
  scale_fill_continuous(type = "viridis", 
    limits = c(0,30), breaks = c(0, 5, 10, 15, 20, 25,30),
    guide = guide_colourbar(nbin = 100, draw.ulim = FALSE, draw.llim = FALSE,barwidth = 20,
                            title = "Travel volume (%)")
   )+
  theme_mapcan() + theme(legend.position="bottom",
                         plot.title=element_text(size=rel(1.3), face="bold"))+ 
  ggtitle("Before the Pandemic")



pr_geographic2 <- mapcan(boundaries = province, type = standard)
pr_geographic2 <- inner_join(pr_geographic2, A2, by = c("pr_alpha" = "province")) 


m2 <- pr_geographic2 %>%
  ggplot(aes(x = long, y = lat, group = group, fill = Percentage)) +
  geom_polygon(show.legend = NA) +
  annotate(geom = "text",x = 642412.6,y = 201110.2, label = "21%", color = "white",size = 3)+
  annotate(geom = "text",x = 1349519.2,y = 782762.2, label = "4.7%",color = "white",size = 3)+
  annotate(geom = "text",x = -115306.8,y = 644233.4, label = "1%", color = "white",size = 3)+
  annotate(geom = "text",x = 2163606.1,y = 237946.6, label = "3%", color = "white", size = 3)+
  annotate(geom = "text",x = -1092152.6,y = 809288.2, label = "16%", color = "white",size = 3)+
  annotate(geom = "text",x = -1867594.7,y =912726.5, label = "5.2%", color = "white",size = 3)+
  annotate(geom = "text",x = -675361.6,y = 487741.4, label = "0.7%", color = "white",size = 3)+
  annotate(geom = "text",x = -888417.3,y = 1651194.8 , label = "3.6%", color ="white",size = 3)+
  annotate(geom = "text", x = 2413606.1, y = 421394.6,label = "0.7%",color ="black", size = 3)+
  annotate(geom = "text",x = 2695757.5,y = 232727.5, label = "19%", color = "black", size = 3)+
  annotate(geom = "text", x = 1565757, y = -750409 , label = "US 9% & Others 15%", 
           fontface = "italic", color = "black", size = 3) +
  coord_fixed() +
  scale_fill_continuous( type = "viridis",
    limits = c(0,30), breaks = c(0, 5, 10, 15, 20, 25,30),
    guide = guide_colourbar(nbin = 100, draw.ulim = FALSE, draw.llim = FALSE,
                            title = "Travel volume (%)")
    ) +
  theme_mapcan() + theme(legend.position="", 
                         plot.title=element_text(size=rel(1.3), face="bold"))+
  ggtitle("During the Pandemic")


m1 + m2  
```
# Canada map (NLCHI and IATA) - (# of travelers per day)
```{r}
CC <- CRFinal
# get the average months March 2019 to Feb 2020 (except June July August 2019) IATA (before Pandemic)
CC <- subset(CC, !date %in% c(as.Date("2019-01-01"), as.Date("2019-02-01"), as.Date("2020-03-01"), as.Date("2019-06-01"), as.Date("2019-07-01"), as.Date("2019-07-01"), as.Date("2019-08-01")) )
# Reset row names
rownames(CC) <- NULL                

#prepan
CC1 <- CC[1:9,]
#pan
CC2 <- CC[10:18,]

# get the mean for both dataframe
C1 <- colSums(CC1[2:13])
C2 <- colSums(CC2[2:13])

C1 <- data.frame(C1)
C1 <- cbind(province = rownames(C1), C1)
rownames(C1) <- 1:nrow(C1)
#repeat TR for three tritories
C1[nrow(C1) + 1,] <- c( "YT",  2682.378)
C1[nrow(C1) + 1,] <- c( "NT", 2682.378)
C1[nrow(C1) + 1,] <- c( "NU",2682.378)
C1$C1 <- as.numeric(C1$C1)
C1 <- C1 %>% rename(Daily = C1)
C1$province[C1$province == 'PEI'] <- 'PE'
# 273 days pre pandemic 2019
C1$Daily <- (C1$Daily)/273
C1$Daily <- ceiling(C1$Daily)


C2 <- data.frame(C2)
C2 <- cbind(province = rownames(C2), C2)
rownames(C2) <- 1:nrow(C2)
#repeat TR for three tritories
C2[nrow(C2) + 1,] <- c( "YT", 5329)
C2[nrow(C2) + 1,] <- c( "NT", 5329)
C2[nrow(C2) + 1,] <- c( "NU", 5329)
C2$C2 <- as.numeric(C2$C2)
C2 <- C2 %>% rename(Daily = C2)
C2$province[C2$province == 'PEI'] <- 'PE'
## 274 days during the pandemic 2020
C2$Daily <- (C2$Daily)/274
C2$Daily <- ceiling(C2$Daily)

## canada map
library(mapcan)


pr_geographic <- mapcan(boundaries = province, type = standard)
pr_geographic <- inner_join(pr_geographic, C1, by = c("pr_alpha" = "province")) 

df.label <- read.csv("Data/df.label2.csv")
df.label <- df.label %>% left_join(C1 , by= "province")
df.label$Daily <- round(df.label$Daily)


m3 <- pr_geographic %>%
  ggplot(aes(x = long, y = lat, group = group, fill = Daily)) +
  geom_polygon(show.legend = NA) +
  geom_text(data =df.label, aes(x = new.long, y = new.lat, group = 1, label = Daily), 
            size = 4, color = "white")+ 
  annotate(geom = "text",x = 2685757.5,y = 232727.5,label = "648", color = "black", size = 4)+
  annotate(geom = "text", x = 2413606.1, y = 421394.6,label = "19",color ="black", size = 4)+
  annotate(geom = "text", x = 1565757, y = -750409 , label = "US 479 & Others 300", 
           fontface = "italic", color = "black", size = 4) +
  coord_fixed() +
  theme_mapcan() +
  scale_fill_continuous(type = "viridis",
    limits = c(0,900), breaks = c(25,50,75, 100, 200, 300, 400, 500,600, 700,800,900),
    #limits = c(0,900), breaks = c(25,50,75,100,250,500,750,900),
    guide = guide_colourbar(nbin = 13, draw.ulim = FALSE, draw.llim = FALSE, barwidth = 20,
                           title = "Total travel volume (Daily)", label.hjust = 0.7, 
                           label.vjust = 0.79,
                           label.theme = element_text(angle = 90, size=7.9))
    ) +
  theme_mapcan() + theme(legend.position="bottom",
                         plot.title=element_text(size=rel(1.3), face="bold"))+
  ggtitle("Before the Pandemic")


pr_geographic2 <- mapcan(boundaries = province, type = standard)
pr_geographic2 <- inner_join(pr_geographic2, C2, by = c("pr_alpha" = "province")) 

#C2["diff"] <- C1$Daily - C2$Daily
df.label <- read.csv("Data/df.label2.csv")
df.label <- df.label %>% left_join(C2 , by= "province")


m4 <- pr_geographic2 %>%
  ggplot(aes(x = long, y = lat, group = group, fill = Daily)) +
  geom_polygon(show.legend = NA) +
  geom_text(data =df.label, aes(x = new.long, y = new.lat, group = 1, label = Daily),
            size = 4, color = "white")+ 
  annotate(geom = "text", x = 2715757.5,y = 232727.5,label = "115", color = "black", size = 4)+
  annotate(geom = "text", x = 2413606.1, y = 421394.6,label = "5",color ="black", size = 4)+
  annotate(geom = "text", x = 1565757, y = -750409 , label = "US 54 & Others 85", 
           fontface = "italic", color = "black", size = 4) +
  coord_fixed() +
  scale_fill_continuous( type = "viridis",
    limits = c(0,900), breaks = c(25,50,75,100,250,500,750,900),
    guide = guide_colourbar(nbin = 10, draw.ulim = FALSE, draw.llim = FALSE, barwidth = 15,
                            title = "Travel volume (Daily)",
                            label.theme = element_text(angle = 90, size=7.8))
    ) +
  theme_mapcan() + theme(legend.position="", 
                         plot.title=element_text(size=rel(1.3), face="bold"))+
  ggtitle("During the Pandemic")

m3 + m4 
#ggsave("Figure/map2.png", width = 12, , height = 8)
```
# plot infected NLCHI
```{r}
#rolling percentage
library(zoo)
Intype <- read.csv("Data/IM215194-TravelType.csv")
Intype$REPORTED_DATE <- as.Date(as.character(Intype$REPORTED_DATE), format = "%Y-%m-%d")

# Change date to Sep- May
Intype <- Intype %>% filter(Intype$REPORTED_DATE >= as.Date("2020-09-01") & Intype$REPORTED_DATE <= as.Date("2021-05-31") )
#consider unknown as not Travel-related infected (unknown source was not alot)
Intype["Tot.NotTravel"] <-rowSums(Intype[, c("Tot.NoTR", "Tot.Unknown")])
Intype <- select(Intype,-c("Tot.NoTR", "Tot.Unknown"))
Intype <- Intype %>% rename(date = REPORTED_DATE)

#add month-date
Intype$year  <- strftime(Intype$date, "%Y")   
Intype$month <- strftime(Intype$date, "%m") 


#average
Ave.df1 <- aggregate(Tot.Int ~ month + year , Intype , mean )
Ave.df2 <- aggregate(Tot.Dom ~ month + year , Intype , mean )
Ave.df <- Ave.df1 %>% left_join(Ave.df2 , by= "month")

#make one column for date
Ave.df  <- Ave.df  %>%
  mutate(date = with(., sprintf("%s-%02s", year.x, month)))
Ave.df$date <- as.Date(paste(Ave.df$date,"-01",sep=""))  # convert to date
Ave.df <- select(Ave.df  , c(date, Tot.Int, Tot.Dom))
# add a row (repeat the last row) for end of May  for plotting
#x <- data.frame(date = as.Date("2021-05-31"), Tot.Int = 0.54838710 , Tot.Dom = 3.4516129)
#Ave.df <- rbind(Ave.df, x)

## repeat days for plotting 
Ave.df["Ym"] <- format(as.Date(Ave.df$date), "%Y-%m")

Av_daily <- Ave.df %>% select(date) %>% 
   complete(date=  seq.Date(min(date), max(date)+30, by="day"),) %>% 
   mutate(Ym=paste(year(date),str_pad(month(date), 2, pad = "0"),sep = "-"))
  
Av_daily <- Av_daily %>% left_join(Ave.df, by="Ym")
Av_daily <- select(Av_daily, c("date.x", "Tot.Int" ,"Tot.Dom" ))
Av_daily <- Av_daily %>% rename(date = date.x)


df4 <- select(Intype, c("date", "Tot.Int", "Tot.Dom" ))
df4[df4 == 0] <- NA

XX <- df4 %>% left_join(Av_daily , by="date")

```

```{r}
colLeg <- c("INT" = cpalete[1], "CA" = cpalete[2])

p7 <- ggplot() + 
  geom_point(data=XX, aes(x=date, y= Tot.Dom.x, color='CA')) +
  geom_line( data=XX, aes(x=date, y= Tot.Dom.y, col='CA'), size=1) +
  geom_point(data=XX, aes(x=date, y= Tot.Int.x, color= 'INT')) +
  geom_line( data=XX, aes(x=date, y=Tot.Int.y, col='INT'), size=1) +
  
  labs(x="", y="\n Infected travellers (daily)", title="Travel-related cases (NLCHI)") +
  scale_x_date(date_breaks = "1 month", date_labels = "%b %y") +
  scale_color_manual(values = colLeg) +
  guides(color = guide_legend(title = "Departure Origin"), size= rel(1.3))+
  theme_classic() + theme(axis.text.x = element_text(angle = 90, size=rel(1.2)),
                          legend.position="bottom",
                          legend.text=element_text(size=rel(1.2)),
                          plot.title=element_text(size=rel(1.3), face="bold"),
                          axis.title = element_text(size=rel(1.1)),
                          axis.text.y = element_text(size=rel(1.2)))

p7
```

##plots
```{r}
(p10 + p5 ) + plot_annotation(tag_levels = 'A')
ggsave("Figure/Volume.png", width = 14, , height = 5, dpi =500)
ggsave(file = "Figure/BMB/Volume.eps", width = 14, , height = 5, dpi= 500)

(m3+m4 ) + plot_annotation(tag_levels = 'A')
ggsave("Figure/Daily.png", width = 10, , height = 6, dpi= 500)
ggsave(file = "Figure/BMB/Daily.eps", width = 10, , height = 6, dpi= 500)


(m1+m2 ) + plot_annotation(tag_levels = 'A')
ggsave("Figure/Appred.png", width = 10, , height = 6, dpi= 500)
ggsave(file = "Figure/BMB/Appred.eps", width = 10, , height = 6, dpi= 500)


##heights = unit(c(10, 1 ), c('cm', 'null')), the first row will occupy 10cm, while the second will expand to fill the ## remaining area.
(p10+p5)/(m3+m4 ) + plot_layout(heights = unit(c(6.5, 1 ), c('cm', 'null'))) + plot_annotation(tag_levels = 'A')
ggsave("Figure/reduction3.png", width = 14, , height = 12, dpi= 500)
ggsave(file = "Figure/BMB/reduction3.eps", width = 14, , height = 12, dpi= 500)


(p6)/(m1+m2 ) + plot_layout(heights = unit(c(5.8, 1 ), c('cm', 'null'))) + plot_annotation(tag_levels = 'A')
ggsave("Figure/corrected2.png", width = 9, , height = 10, dpi= 500)
ggsave(file = "Figure/BMB/corrected2.eps", width = 9, , height = 10, dpi= 500)

(p1 + p7 ) + plot_annotation(tag_levels = 'A')
ggsave("Figure/NLCHI.png", width = 10, , height = 6, dpi =500)
ggsave(file = "Figure/BMB/NLCHI.eps", width = 10, , height = 6, dpi= 500)


(p2 + p3)/p4 + plot_annotation(tag_levels = 'A')
ggsave("Figure/diffsource.png", width = 12, , height = 8, dpi =1200)
ggsave(file = "Figure/BMB/diffsource.eps", width = 12, , height = 8, dpi= 1200)

```





